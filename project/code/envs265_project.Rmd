---
title: 'A geospatial analysis of energy transition mining in the U.S.'
author: "Carrie Hamilton"
date: "`r Sys.Date()`"
output: 
  html_document:
    widescreen: yes
    df_print: paged
    highlight: "pygments"
    css: slides.css
  

---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(pacman)
p_load(sf,tidyverse,usmap,ggplot2,plotly,tidycensus,flair,styler,devtools)
# install_github("ateucher/rmapshaper")
# library(rmapshaper)
```


```{css, echo=FALSE}
.code-format {
  background-color: white;
  border: 3px solid blue;
}
```



```{r data, include=FALSE}
#mines in U.S.
minesRaw <- st_read("data/mrdata_usgs_PP1802_Global_CriticalMinerals.gdb", "PP1802_CritMin_pts") %>%
  filter(LOCATION=="United States of America") %>%
  filter(LOC_DETAIL!="Alaska" & LOC_DETAIL!="Hawaii")

#base map
state <- map_data("state")

#census
census_api_key("7492e696e8c0d9bcb8a075682c4dd9e68aad700a", install=TRUE, overwrite=TRUE)

variables <- load_variables(2019, "acs1", cache=TRUE)
county <- get_acs(geography = "county", 
                       variables = "B01003_001", 
                       year = 2019, 
                       geometry=TRUE) %>%
  separate(NAME,into=c("County","State"),sep=", ") %>%
  filter(State!="Alaska" & State!="Hawaii")

# county_simpl <- county %>%
#   st_simplify(preserveTopology =TRUE, dTolerance=10) %>%
#   st_cast("MULTIPOLYGON")
# 
# county_simpl2 <- ms_simplify(county, keep = 0.001,
#                                 keep_shapes = FALSE)
# 
# round(c(object.size(county), object.size(county_simpl), object.size(county_simpl2))/1024)

variables2 <- load_variables(2010, "sf1", cache=TRUE)

#block data not available in acs
censusBlocks <- get_decennial(geography = "block", 
                       variables = "P001001", 
                       year = 2010)
                       geometry=TRUE) 

vars10 <- c("P005003", "P005004", "P005006", "P004003")

il <- get_decennial(geography = "county", variables = vars10, year = 2010,
                    summary_var = "P001001", state = "IL", geometry = TRUE) %>%
  mutate(pct = 100 * (value / summary_value))

# %>%
#   separate(NAME,into=c("County","State"),sep=", ") %>%
#   filter(State!="Alaska" & State!="Hawaii")

```


## {.smaller}
```{r filtering, class.source = "code-format"}
mines <- minesRaw %>% #filter to key energy transition minerals
  filter (CRITICAL_MINERAL %in% c("Aluminum",
                                  "Cadmium",
                                  "Cobalt",
                                  "Copper",
                                  "Dysprosium",
                                  "Gallium",
                                  "Indium",
                                  "Lithium",
                                  "Manganese",
                                  "Neodymium",
                                  "Nickel",
                                  "Silver",
                                  "Selenium",
                                  "Tellurium",
                                  "Rare-Earth Elements"))

minesKeyMinerals <- minesRaw %>% #filter to key energy transition minerals
  filter (CRITICAL_MINERAL %in% c("Cobalt",
                                  "Lithium",
                                  "Tellurium",
                                  "Rare-Earth Elements"))
```


```{r}
map3 <- ggplot() + 
  geom_polygon(data=state, #add base map
               color = "black", 
               fill="white",
               aes(x=long, y=lat, group=group)) + 
  geom_point(data=minesKeyMinerals, #add mines
             aes(x=LONGITUDE, y=LATITUDE, color=CRITICAL_MINERAL,
                 text=paste("",CRITICAL_MINERAL))) +
  theme_minimal()+ #remove grey background
  theme(legend.position="none", #remove legend, axes labels/ticks
        axis.title.x=element_blank(), 
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(), 
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank()) + 
  ggtitle('"Critical Mineral" Mines & Deposits in U.S.:<br>Cobalt, Lithium, Tellurium, Rare Earths') +
  coord_fixed(1.3) #adjust aspect ratio

ggplotly(map3, tooltip="text") %>% #make interactive
  style(hoverinfo="none", traces=1)
```

```{r}
map4 <- ggplot() +
  geom_sf(data=county, #add base map
               color = NA,
               aes(fill=estimate)) +
  coord_sf()+
  scale_fill_viridis_c(option = "magma") +
  geom_point(data=minesKeyMinerals, #add mines
             aes(x=LONGITUDE, y=LATITUDE, color=CRITICAL_MINERAL,
                 text=paste("",CRITICAL_MINERAL))) +
  theme_minimal()+ #remove grey background
  #theme(legend.position="none", #remove legend, axes labels/ticks
        # axis.title.x=element_blank(),
        # axis.text.x=element_blank(),
        # axis.ticks.x=element_blank(),
        # axis.title.y=element_blank(),
        # axis.text.y=element_blank(),
        # axis.ticks.y=element_blank()) +
  ggtitle('"Critical Mineral" Mines & Deposits in U.S.:<br>Cobalt, Lithium, Tellurium, Rare Earths')
 # coord_fixed(1.3) #adjust aspect ratio

ggplotly(map4, tooltip="text") %>% #make interactive
  style(hoverinfo="none", traces=1)
```


```{r buffer}
buf50km <- st_buffer(minesKeyMinerals, dist = 0.5)

map5 <- ggplot() +
  geom_sf(data=county)+ #add base map
  coord_sf()+
  scale_fill_viridis_c(option = "magma") +
  geom_point(data=minesKeyMinerals, #add mines
             aes(x=LONGITUDE, y=LATITUDE, color=CRITICAL_MINERAL,
                 text=paste("",CRITICAL_MINERAL))) +
  geom_sf(data=buf50km, color="blue",fill=alpha(0.9))+
  theme_minimal()+ #remove grey background
  theme(legend.position="none", #remove legend, axes labels/ticks
  axis.title.x=element_blank(),
  axis.text.x=element_blank(),
  axis.ticks.x=element_blank(),
  axis.title.y=element_blank(),
  axis.text.y=element_blank(),
  axis.ticks.y=element_blank()) +
  ggtitle('"Critical Mineral" Mines & Deposits in U.S.:<br>Cobalt, Lithium, Tellurium, Rare Earths')
 # coord_fixed(1.3) #adjust aspect ratio

ggplotly(map5, tooltip="text") %>% #make interactive
  style(hoverinfo="none", traces=1)
```


